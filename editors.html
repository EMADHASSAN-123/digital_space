<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DiagramGPT تفاعلي</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<style>
  #diagram-container {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    min-height: 500px;
    background-color: #f9fafb;
    overflow: auto;
  }
  .tooltip {
    position: absolute;
    text-align: center;
    padding: 6px;
    font-size: 14px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border-radius: 4px;
    pointer-events: none;
  }
</style>
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-5xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6 text-center">تحويل النص إلى مخطط تفاعلي</h1>

  <textarea id="user-text" rows="5" class="w-full p-3 border rounded-lg mb-4" placeholder="أدخل نص البوست هنا..."></textarea>
  <button id="generate-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
    إنشاء المخطط
  </button>

  <div id="diagram-container" class="mt-6 relative"></div>
</div>

<script>
const generateBtn = document.getElementById('generate-btn');
const diagramContainer = document.getElementById('diagram-container');

generateBtn.addEventListener('click', async () => {
  const userText = document.getElementById('user-text').value.trim();
  if (!userText) return alert('يرجى إدخال نص لتحويله إلى مخطط.');

  diagramContainer.innerHTML = "<p class='text-gray-500'>جاري إنشاء المخطط...</p>";

  try {
    // استدعاء API عبر خادم وسيط
    const response = await fetch('/api/diagram', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ prompt: userText })
    });

    if (!response.ok) throw new Error('فشل في إنشاء المخطط.');

    const data = await response.json();

    // تنظيف المخطط الحالي
    diagramContainer.innerHTML = "";

    // تحويل JSON المستلم من API إلى مخطط D3
    const nodes = data.nodes; // مثال: [{id:1, name:"A", info:"..."}]
    const links = data.links; // مثال: [{source:1, target:2}]

    const width = diagramContainer.clientWidth;
    const height = 500;

    const svg = d3.select("#diagram-container")
                  .append("svg")
                  .attr("width", width)
                  .attr("height", height)
                  .call(d3.zoom().on("zoom", (event) => {
                    svg.attr("transform", event.transform);
                  }))
                  .append("g");

    const simulation = d3.forceSimulation(nodes)
                         .force("link", d3.forceLink(links).id(d => d.id).distance(150))
                         .force("charge", d3.forceManyBody().strength(-500))
                         .force("center", d3.forceCenter(width / 2, height / 2));

    const link = svg.selectAll("line")
                    .data(links)
                    .enter().append("line")
                    .attr("stroke", "#999")
                    .attr("stroke-width", 2);

    const node = svg.selectAll("circle")
                    .data(nodes)
                    .enter().append("circle")
                    .attr("r", 25)
                    .attr("fill", "#1e40af")
                    .call(d3.drag()
                      .on("start", dragstarted)
                      .on("drag", dragged)
                      .on("end", dragended));

    const tooltip = d3.select("body").append("div")
                      .attr("class", "tooltip")
                      .style("opacity", 0);

    node.on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", .9);
      tooltip.html(d.info || d.name)
             .style("left", (event.pageX + 10) + "px")
             .style("top", (event.pageY - 28) + "px");
    }).on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

    simulation.on("tick", () => {
      link.attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

      node.attr("cx", d => d.x)
          .attr("cy", d => d.y);
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x; d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    }

  } catch (error) {
    console.error(error);
    diagramContainer.innerHTML = "<p class='text-red-500'>حدث خطأ أثناء إنشاء المخطط.</p>";
  }
});
</script>
</body>
</html>
